---
- name: Enable bgpd
  become: True
  ansible.builtin.lineinfile:
    path: /etc/rc.conf.local
    regexp: ^bgpd_flags=.*$
    line: 'bgpd_flags=""'
    create: yes

- name: Place generated bgpd.conf into /etc/bgpd.candidate.conf
  become: True
  ansible.builtin.copy:
    src: "{{ lookup('env', 'HOME') }}/arouteserver/{{ inventory_hostname }}-openbgpd.cfg"
    dest: /etc/bgpd.candidate.conf

- name: Test the candidate bgpd.conf
  become: True
  ansible.builtin.command:
    cmd: bgpd -n -f /etc/bgpd.candidate.conf
  register: bgpd_config_test

- name: Install the candidate bgpd.conf
  become: True
  when: bgpd_config_test.rc == 0
  ansible.builtin.command:
    cmd: mv /etc/bgpd.candidate.conf /etc/bgpd.conf

- name: Run `bgpctl reload`
  become: True
  when: bgpd_config_test.rc == 0
  ansible.builtin.command:
    cmd: bgpctl reload
